name: Deploy to CocoaPods and Swift Package Manager

on:
  release:
    types:
      - published
  workflow_dispatch:

jobs:
  cocoapods:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Validate versions match
        run: |
          PODSPEC_VERSION=$(grep -E "s.version\s*=\s*" ShopifyCheckoutSheetKit.podspec | sed -E 's/.*"([^"]+)".*/\1/')
          SWIFT_VERSION=$(grep -E "public let version = " Sources/ShopifyCheckoutSheetKit/ShopifyCheckoutSheetKit.swift | sed -E 's/.*"([^"]+)".*/\1/')
          GIT_TAG="${{ github.event.release.tag_name }}"
          
          echo "Podspec version: $PODSPEC_VERSION"
          echo "Swift version: $SWIFT_VERSION"
          echo "Git tag: $GIT_TAG"
          
          if [ "$PODSPEC_VERSION" != "$GIT_TAG" ]; then
            echo "❌ Error: Podspec version ($PODSPEC_VERSION) doesn't match Git tag ($GIT_TAG)"
            exit 1
          fi
          
          if [ "$SWIFT_VERSION" != "$GIT_TAG" ]; then
            echo "❌ Error: Swift version ($SWIFT_VERSION) doesn't match Git tag ($GIT_TAG)"
            exit 1
          fi
          
          echo "✅ All versions match!"

      - uses: ruby/setup-ruby@0481980f17b760ef6bca5e8c55809102a0af1e5a # v1.263.0
        with:
          bundler-cache: true

      - name: Deploy to Cocoapods
        run: |
          set -eo pipefail
          bundle exec pod lib lint --allow-warnings --verbose
          bundle exec pod trunk push --allow-warnings --verbose
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
