#!/bin/bash

# Parse arguments for verbose flag
VERBOSE=false
ARGS=()

for arg in "$@"; do
    if [[ "$arg" == "--verbose" ]]; then
        VERBOSE=true
    else
        ARGS+=("$arg")
    fi
done

# Default to check mode if no argument provided
MODE="${ARGS[0]:-check}"

# Validate the mode
if [[ "$MODE" != "check" && "$MODE" != "fix" ]]; then
    echo "‚ùå Invalid mode: $MODE"
    echo "Usage: $0 [check|fix] [--verbose]"
    echo "  check: Run linters in check mode (default)"
    echo "  fix:   Run linters in fix mode to auto-fix issues"
    echo "  --verbose: Show detailed output from linters"
    exit 1
fi

# Function to provide installation instructions
print_install_instructions() {
    echo "üîß FIX:"
    echo "   Shopify employee? Run 'dev up'"
    echo "   Not a Shopify employee? Install via homebrew:"
    echo "     - SwiftLint: 'brew install swiftlint' / https://github.com/realm/SwiftLint"
    echo "     - SwiftFormat: 'brew install swiftformat' / https://github.com/nicklockwood/SwiftFormat"
}

# Check for SwiftLint
if ! which swiftlint >/dev/null; then
    echo "‚ö†Ô∏è WARN: SwiftLint not installed"
    print_install_instructions
    exit 1
fi

# Check for SwiftFormat
if ! which swiftformat >/dev/null; then
    echo "‚ö†Ô∏è WARN: SwiftFormat not installed"
    print_install_instructions
    exit 1
fi

# Run SwiftLint
QUIET_FLAG=""
if [[ "$VERBOSE" == "false" ]]; then
    QUIET_FLAG="--quiet"
fi

if [[ "$MODE" == "check" ]]; then
    echo "üîÑ Running SwiftLint in check mode..."
    swiftlint lint --strict $QUIET_FLAG Samples Sources/ShopifyAcceleratedCheckouts
    LINT_STATUS=$?
else
    echo "üîÑ Running SwiftLint in fix mode..."
    swiftlint lint --fix $QUIET_FLAG Samples Sources/ShopifyAcceleratedCheckouts
    LINT_STATUS=$?
fi
echo "SwiftLint exit status: $LINT_STATUS"

# Run SwiftFormat
if [[ "$MODE" == "check" ]]; then
    echo "üîÑ Running SwiftFormat in check mode..."
    swiftformat . $QUIET_FLAG --lint
    FORMAT_STATUS=$?
else
    echo "üîÑ Running SwiftFormat in fix mode..."
    swiftformat . $QUIET_FLAG
    FORMAT_STATUS=$?
fi
echo "SwiftFormat exit status: $FORMAT_STATUS"

# Handle exit codes for check mode
if [[ "$MODE" == "check" ]]; then
    if [ $LINT_STATUS -ne 0 ]; then
        echo "‚ùå SwiftLint detected issues that need to be fixed."
        echo "üîß How to fix:"
        echo "   Shopify employee? Run 'dev fix' or 'dev lint --verbose' to see detailed output"
        echo "   Not a Shopify employee? Run './Scripts/lint fix' to auto-fix issues"
        echo "   Then fix any remaining non-autofixable issues manually"
        exit 1
    fi
    
    if [ $FORMAT_STATUS -ne 0 ]; then
        echo "‚ùå SwiftFormat detected issues that need to be fixed."
        echo "üîß How to fix:"
        echo "   Shopify employee? Run 'dev fix' or 'dev lint --verbose' to see detailed output"
        echo "   Not a Shopify employee? Run './Scripts/lint fix' to auto-fix issues"
        exit 1
    fi
    
    echo "‚úÖ All linting checks passed!"
else
    echo "‚úÖ Linting fixes applied!"
fi
